// === Miniapp frontend (Telegram WebApp + VK Mini Apps) ===
// Endpoint of Yandex Cloud Function
const FUNCTION_URL = "https://functions.yandexcloud.net/d4e1po7m6l0nno0u1c5h";

/* =========================================================
   Tracks (embedded from CSV)
========================================================= */
const IT_TRACK_GROUPS = [{"group": "ПРИМЕР\nСистемный анализ", "items": [{"title": "Аналитик DWH", "desc": "Что предстоит делать:\n●        Собирать и анализировать требования потребителей данных\n●        Загружать данные из систем-источников в платформы данных, описывать данные\n●        Рассчитывать метрики, следить за качеством данных\n●        Делиться идеями по развитию инструментов платформы данных\nНеобходимые навыки:\n●        Уверенное знание SQL на уровне написания сложных запросов (оконные функции, подзапросы)\n●        Понимание принципов функционирования хранилищ данных\nЖелательно: \n●       Базовое знание языка программирования (желательно Python).\nСтажировка будет актуальна:\n●        Как студентам профильных вузов, так и выпускникам онлайн-школ"}, {"title": "Системный аналитик", "desc": "Что предстоит делать:\n●        Анализировать и уточнять бизнес- и системные требования, выстраивать процессы\n●        Проектировать и документировать новые фичи\n●        Взаимодействовать с коллегами и внешними командами для реализации интеграционных решений\n●        Сопровождать и поддерживать текущие системы\nНеобходимые навыки:\n●        Знание способов выявлений требований\n●        Базовое знание различных способов интеграций и типов архитектур\n●        Базовое знание нотаций UML и BPMN\n●        Базовое знание SQL (Select, Join), умение писать простые вопросы\nСтажировка будет актуальна:\n●        Как студентам профильных вузов, так и выпускникам онлайн-школ\n●        Кандидатам только из Москвы"}]}, {"group": "Data Scientist", "items": [{"title": "Data Scientist", "desc": "Команда: \nМоделирования розничных рисков\n\nОписание команды:\nНаша команда занимается построением и внедрением моделей оценки рисков для розничного сегмента. Наши модели участвуют в критически важных процессах: расчёт резервов, кредитный скоринг, персонализация предложений и другие бизнес-кейсы. У нас реальные задачи с высокой бизнес-востребованностью, большими объемами данных, мы ценим инженерный подход к работе.\n\nМы вам доверим:\n— Собирать, анализировать и обрабатывать данные;\n— Разрабатывать модели, помогающие в оценке рисков с использованием внутренних и внешних данных;\n— Разрабатывать модели для регуляторных целей ПВР/IFRS9;\n— Строить модели для разнообразных бизнес-задач банка;\n— Участвовать в создании пайплайнов построения моделей (от сбора данных до выведения в продакшн).\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— Имеет образование в области математики, прикладной математики, науки о данных, компьютерных наук, искусственного интеллекта, машинного обучения и смежных областях;\n— Знание английского языка на уровне Intermediate и выше;\n— Владеет Python на средний уровне;\n— Обладает опытом в области классического машинного обучения (Classic Machine Learning) и анализа данных (Data Analysis).\n\nБудет плюсом:\n —  Владение SQL на начальном уровне;\n—  Навык настройки и работы с инфраструктурой (DevOps)."}, {"title": "Data Scientist", "desc": "Команда: \nУправление жизненныи циклом клиента\n\nОписание команды:\nКоманда развивает сервисы по открытию счетов новым и действующим клиентам банка, отвечает за удобный процесс с комплексной проверкой личности и данных \n\nМы вам доверим:\n— работа с алгоритмами машинного обучения, построение и тестирование предиктивных моделей;\n— автоматизация отчетности через AirFlow;\n— усовершенствование автоматических ответов в чате клиентам;\n— развитие распознавания документов.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 35 часов в неделю (гибридный формат);\n— образование по специальности бизнес информатика, програмная инженерия, компьютерные науки, прикладная математика и информатика , програмирование и смежные технические специальности;\n— знает английский язык на уровне Intermediate и выше;\n— владеет Python и SQL на продвинутом уровне;\n— разбирается в статистике, теории вероятности и методах проверки гипотез;\n— опыт написания классических моделей.\n\nБудет плюсом:\n — учебный опыт разработки приложений; \n— реализация проектов с применением вайбкодинга;\n— использование AI и LLM в учебных проекта;\n— опыт написания генеративных моделей."}, {"title": "Data Scientist ( + )", "desc": "Команда: \nКоманда банковских сервисов и управления ликвидностью\n\nОписание команды:\nПродуктовая команда банковских сервисов и управления ликвидностью занимается разработкой и развитием расчетных и пассивных решений для корпоративных клиентов и состоит из трёх Agile-команд, две из которых — Решения для ликвидности и Международный бизнес. Решения для ликвидности отвечают за продукты безналичных расчетов и инструменты управления ликвидностью в рублях, включая расчетные счета и специализированные решения для клиентов корпоративного бизнеса. Международный бизнес фокусируется на валютных платежах, валютном контроле и остатках в иностранной валюте, обеспечивая автоматизированную обработку платежей и документов как внешних, так и внутренних клиентов всех сегментов в рамках требований валютного регулирования.\n\nМы вам доверим:\n— Улучшать пользовательские сценарии использования банковских продуктов с помощью LLM и OCR, делая взаимодействие более простым и удобным;\n— Ускорять внутренние банковские процедуры за счёт внедрения AI-решений;\n— Разрабатывать классические ML-модели для бизнес-задач, таких как прогноз оттока, бюджетирование и другие;\n— Замерять эффект от внедрённых изменений с помощью статистических тестов.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 35 часов в неделю (гибридный формат);\n— образование по специальности прикладная математика и информатика, физика, бизнес информатика и смежной технической области;\n— знает английский язык на уровне Upper-Intermediate и выше;\n— обладает глубокими знаниями статистики и уверенно применяет методы проверки гипотез для анализа данных и оценки моделей;\n— уверенно владеет Python;\n— обладает практическими навыками в машинном обучении и работе с большими языковыми моделями;\n— умеет работать в команде, задавать вопросы, получать обратную связь и адаптироваться к новым задачам и технологиям.\n\nБудет плюсом:\n— SQL на базовом уровне;\n— готов изучать и применять современные подходы в области LLM, включая обучение, тонкую настройку и оценку моделей;\n— опыт и знания в области Computer Vision;\n— интерес к инновационным технологиям и желание развиваться в области искусственного интеллекта, особенно в контексте корпоративных решений."}]}, {"group": "Data Analyst", "items": [{"title": "Data Analyst", "desc": "Команда: \nРазработки антифрод data-сервисов\n\nОписание команды:\nМы создаём и поддерживаем data-продукты для антифрод-систем — от сбора и анализа данных до решений на основе искусственного интеллекта. Наша цель — защита клиентов от мошенничества и автоматизация процессов подразделения. Мы улучшаем алгоритмы детекции подозрительных транзакций и клиентов, а также разрабатываем самоадаптируемые решения, которые минимизируют участие человека в обработке обращений и реагировании на новые схемы мошенничества.\n\nМы вам доверим:\n— Собирать, анализировать и обрабатывать данные;\n— Настраивать автоматическую отчётность и создавать дашборды для анализа данных;\n— Искать и оценивать источники новых и ценных данных, которые могут быть полезны для продукта и повышения эффективности детекции рисков;\n— Исследовать гипотезы по улучшению продукта в рамках направления антифрода и автоматизировать процессы.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— имеет образование в области прикладной математики, прикладной информатики, физики, социологии или смежном направлении;\n— владеет Excel и SQL на среднем уровне;\n— владеет инструментами визуализации отчетности (BI); \n— обладает знаниями в области математической статистики;\n— отличается высокой аккуратностью в работе с данными;\n— обладает навыком коммуникации и легко налаживает контакт с коллегами из разных команд.\n\nБудет плюсом:\n— знание Python на начальном уровне."}, {"title": "Data Analyst", "desc": "Команда: \nКоманда по работе с клиентами среднего бизнеса\n\nОписание команды:\nМы — команда, которая работает с клиентами из сегмента среднего бизнеса. В рамках трансформации SDB (Self-Driving Bank) мы экспериментируем с новым подходом к обслуживанию: внедряем многослойную модель, где клиент может взаимодействовать с банком через разные каналы — цифровой, гибридный и личный. Это позволяет персонализировать поддержку под потребности каждого клиента и эффективно распределять время и ресурсы менеджеров.\n\nМы вам доверим:\n— Внедрять новую модель продаж и настраивать взаимодействие между всеми каналами: цифровым, гибридным, портфельным и личным, чтобы они работали как единая система;\n— Анализировать, какие клиенты готовы перейти из одного канала обслуживания в другой — например, из личного общения в цифровой формат, и наоборот;\n— Участвовать в разработке новых решений для управления продажами с использованием прототипов, вайбкодинга и экспериментов;\n— Интегрировать AI-инструменты, которые помогут менеджерам лучше понимать потребности клиентов и предлагать релевантные продукты;\n— Собирать и структурировать обратную связь от клиентов и менеджеров для постоянного улучшения продуктов и сервисов.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (очный формат);\n— имеет образование в области прикладной математики, прикладной информатики, физики, бизнес информатики, компьютерных наук или смежном техническом направлении;\n— знает английский язык на уровне Intermediate и выше;\n— владеет Excel и SQL на среднем уровне;\n— имеет опыт использования AI в проектах, разбирается в LLM и составлении промтов;\n— умеет разбираться в сложных процессах и проактивен.\n\nБудет плюсом:\n— знание Python на начальном уровне."}, {"title": "Data Analyst", "desc": "Команда: \nУправление жизненныи циклом клиента \n\nОписание команды:\nНаша цель — создание новой единой мастер-системы для хранения и управления клиентскими данными и процессами обслуживания юридических лиц и ИП.\n\nМы вам доверим:\n— построение сквозной аналитики процессов команд\n— поиск гипотиз для улучшения джобов клиентов\n— разрабатывать систему метрик для продукта\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 35 часов в неделю (гибридный формат);\n— имеет образование в области бизнес информатики, прикладной математики и информатики, програмной инженерии, компьютерный наук или смежном техническом направлении;\n— знает английский язык на уровне Intermediate и выше;\n— владеет Python и SQL на продвинутом уровне;\n— разбирается в статистике, теории вероятности и методах проверки гипотез;\n\nБудет плюсом:\n— использование AI и LLM в учебных проектах;\n— понимание принципов ML."}, {"title": "Data Analyst ( + )", "desc": "Команда: \nКоманда банковских сервисов и управления ликвидностью\n\nОписание команды:\nПродуктовая команда банковских сервисов и управления ликвидностью занимается разработкой и развитием расчетных и пассивных решений для корпоративных клиентов и состоит из трёх Agile-команд, две из которых — Решения для ликвидности и Международный бизнес. Решения для ликвидности отвечают за продукты безналичных расчетов и инструменты управления ликвидностью в рублях, включая расчетные счета и специализированные решения для клиентов корпоративного бизнеса. Международный бизнес фокусируется на валютных платежах, валютном контроле и остатках в иностранной валюте, обеспечивая автоматизированную обработку платежей и документов как внешних, так и внутренних клиентов всех сегментов в рамках требований валютного регулирования.\n\nМы вам доверим:\n— формулировать и проверять гипотезы для развития транзакционных продуктов;\n— конструирование продуктовых метрик и ускорение процессов аналитики;\n— систематизировать данные из разных источников в аналитические отчёты и дашборды;\n— совершенствовать Pipeline прогнозирования финансовых метрик;\n— улучшать data-практики как внутри команды, так и на уровне домена.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 35 часов в неделю (гибридный формат);\n— образование по специальности прикладная математика и информатика, физика, бизнес информатика и смежной технической области;\n— знает английский язык на уровне Upper-Intermediate и выше;\n— обладает глубокими знаниями статистики и уверенно применяет методы проверки гипотез для анализа данных и оценки моделей;\n— имеет опыт работы с данными и базовыми навыками программирования на SQL, желательно в области обработки естественного языка или машинного обучения, с пониманием основ работы с большими языковыми моделями;\n— владеет Python на уровне уверенного пользователя;\n— умеет работать в команде, задавать вопросы, получать обратную связь и адаптироваться к новым задачам и технологиям.\n\nБудет плюсом:\n— опыт и знания в области Computer Vision;\n— знание классических алгоритмов машииного обучени и опыт разработки ML-проектов на Python;\n— интерес к инновационным технологиям и желание развиваться в области искусственного интеллекта, особенно в контексте корпоративных решений."}]}];
const NONIT_TRACK_GROUPS = [{"group": "Sales and Customer service", "items": [{"title": "Products Sales", "desc": "nan"}, {"title": "Депозитарное обслуживание (выплата доходов по ценным бумагам)", "desc": "Команда: \nОтдел депозитарного обслуживания\n\nОписание команды:\nМы оказываем клиентам депозитарные услуги по получению доходов по ценным бумагам в пользу Депонента, а также услуги по предоставлению информации, распространяемой Центральным депозитарием, эмитентами, Регистраторами и иными депозитариями для владельцев ценных бумаг\n\nМы вам доверим:\n— подготовку писем и ответов клиентам по запросам о прошедших корпоративных действиях и произведенных выплатах;\n— отслеживание своевременности подачи инструкций в вышестоящие депозитарии и регистраторы, а также проверку статусов поданных инструкций;\n— мониторинг качества данных о предстоящих корпоративных действиях в системе депозитарного учёта.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— имеет образование по направлению экономика, финансы или смежные;\n— знает английский язык на уровне Intermediate;\n— имеет средний уровень владения Excel"}, {"title": "Развитие цифровых банковских решений (Products Sales)", "desc": "Команда: \nПродаж и развития продуктов рынка капитала\n\nОписание команды:\nМы — команда, которая работает с продуктами, лежащими в самом сердце клиентского сервиса и бизнес-процессов: ВЭД, сбор выручки, РКО, управление ликвидностью и другие решения, востребованные среди корпоративных клиентов. Мы тесно взаимодействуем с клиентскими менеджерами, продуктовыми командами и техническими специалистами, чтобы запускать новые продукты, масштабировать успешные кейсы, обучать коллег и предлагать клиентам именно те решения, которые им нужны. В нашей работе важен комплексный подход, аналитика спроса и предложения, а также развитие лидерских и экспертных навыков.\n\nМы вам доверим:\n— Развивать продажи транзакционных продуктов на закреплённой территории;\n— Запускать совместно с продуктовыми командами новые решения, формировать спрос и развивать рынок;\n— Обучать и вовлекать клиентских менеджеров, чтобы они могли уверенно предлагать продукты;\n— Проводить вебинары, тренинги и презентации для донесения ценности продуктов до клиента;\n— Масштабировать успешные кейсы, внедряя лучшие практики продаж по всей сети.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (очный формат);\n— имеет образование в области развития цифровых продуктов и сервисов, экономике, менеджменте проектов и смежном;\n— знает английский язык на уровне Intermediate и выше;\n— владеет Excel на среднем уровне;\n— умеет работать с Power Point и Figma;\n— умеет находить общий язык с разными командами и клиентами;\n— готов брать ответственность и инициативу.\n\nБудет плюсом:\n — участие в хакатонах, кейс-чемпионатах, конференциях или учебных проектах;\n— интерес к развитию в управлении продуктом и проектами;\n— использование AI и LLM в учебных проектах."}, {"title": "Корпоративное обслуживание", "desc": "Команда: \nКорпоративного обслуживания\n\nОписание команды:\nМы работаем с крупнейшими клиентами банка, юридическими лицами. Принимаем документы, обрабатываем их для дальнейшей работы с юристами, исполняем запросы клиентов, как дистанционно, так в оффлайн формате. Через наше подразделение проходят практически все продукты банка, это отличная возможность погрузится в банковскую деятельность и понять, куда двигаться дальше.\n\nМы вам доверим:\n— Работа с внешними ключевыми клиентами, консультирование и заключение крупных сделок; \n— Оцифровку и разбор поступающих документов как от внешних клиентов, так и от внутренних стейкхолдеров — кредитных экспертов, торгового финансирования, финансовых институтов и других подразделений;\n— Обеспечивать точность и оперативность обработки документации на всех этапах;\n— Взаимодействовать с различными командами для уточнения деталей и согласования процессов;\n— Строить и улучшать процессы обработки документов, делая их более эффективными и клиентоориентированными.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (очный формат);\n— студент или выпускник по специальности финансы, экономика, юриспруденция и смежных направлений;\n— знает английский язык на уровне Intermediate  и выше;\n— владеет Excel на среднем уровне;\n— обладает навыками тайм-менеджмента и умеет расставлять приоритеты;\n— умеет работать в команде и эффективно взаимодействовать с коллегами из разных подразделений.\n\nБудет плюсом:\n — понимает принципы работы с юридическими лицами;\n— владение другими иностранными языками."}, {"title": "Работа с корпоративными клиентами на рынках капитала", "desc": "Команда: \nОтдел продаж корпоративным клиентам на рынках капитала\n\nОписание команды:\nМы занимаемся продажами финансовых инструментов (FX, деривативы, размещение ликвидности) для корпоративных клиентов Среднего, Международного и Крупного сегментов бизнеса. Фокусируемся на развитии цифровых продаж инструментов через платформу (\"Обмен валют\") в онлайн банке. Создаем вместе с продуктовой командой один из самых удобных клиенских сервисов в стране. В 2026м году среди основных фокусов будет внедрение sales AI агентов, которые смогут автономно решать большую часть рутинных задач из процесса продаж.\n\nМы вам доверим:\n— изучать механизмы и модели ценообразования по различным финансовым инструментам (включая FX/Rates derivatives, FX Spot и другие);\n— взаимодействовать с корпоративными и институциональными клиентами, выявлять потребности и формировать на их основе продуктовые решения, коммуницировать с клиентами для решения базовых вопросов;\n— участвовать в сделках от этапа origination до execution;\n— участвовать в сделках и проектах крупных эмитентов по выкупу ценных бумаг: собирать заявки и вести коммуникацию;\n— готовить индикативные предложения по финансовым инструментам;\n— создавать креативные презентации, связанные с продуктами, аналитикой и продажами;\n— помогать команде наполнять контентом и контекстом AI-агентов.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 35 часов в неделю (очный формат);\n— студент или выпускник по специальности финансы, экономика и смежных направлений;\n— знает английский язык на уровне Advanced (необходим навык чтения и написания текста, а также устной речи);\n— имеет продвинутый уровень владения Excel (сводные таблицы, ВПР);\n— имеет высокий навык коммуникации и многозадачности;\n— хочет развиваться в направлении продаж и работать с клиентами;\n— базовые знания рынка капитала.\n\nБудет плюсом:\n — опыт работы с Figma;\n—навык промтинга, работы с AI и LLM;"}]}, {"group": "Внутренний аудит (Audit)", "items": [{"title": "Внутренний аудит рынка капитала и ценных бумаг", "desc": "Команда: \nАудит операций на рынках капитала\n\nОписание команды:\nМы даем акционерам и руководству банка гарантии того, что внутренние процессы выстроены и работают исправно. В зону нашей ответственности входят брокерские операции, депозитарий, специализированный депозитарий (паевые инвестиционные фонды), деривативные продукты, казначейство и много других сложных и интересных областей, многие из которых в настоящий момент являются приоритетными направлениями развития нашего банка.\n\nМы вам доверим:\n— Проводить предварительный анализ зоны аудита: изучать события операционных рисков, регуляторные и внутренние требования, участвовать в интервью и отрисовывать схемы процессов;\n— Работать с данными с использованием LLM и AI агентов: запрашивать и обрабатывать данные из различных источников, выполнять фильтрацию, агрегацию и расчеты;\n— Анализировать материалы, полученные в ходе аудита: проверять данные, изучать первичные документы по сделкам, а также аналитические материалы, включая отчеты по соблюдению лимитных требований;\n— Самостоятельно презентовать результаты проверок менеджменту банка; \n— Изучать практики конкурентов, лучшие отраслевые подходы и привносить их в рамках рекомендаций командам: анализировать отчеты консалтинговых компаний, открытые документы и материалы регуляторов;\n— Подготавливать итоговый отчет по результатам проведённой работы на английском языке.\n\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности финансы и смежных направлений;\n— знает английский язык на уровне Upper-Intermediate и выше и умеет составлять официальные запросы на нем;\n—  владеет продвинутым Excel и базовыми навыками SQL;\n—  имеет опыт работы с объёмными документами (100+ страниц);\n—  обладает высоким уровнем тайм-менеджмента;\n— умеет уверенно отстаивать свою точку зрения, сохраняя конструктивный подход.\n\nБудет плюсом:\n — базовые знания управления проектами."}]}, {"group": "Корпоративное обучение (Methodology)", "items": [{"title": "Методолог в команду корпоративного обучения", "desc": "Команда: \nПроведение и методология обучения сотрудников\n\nОписание команды:\nКоманда создает образовательные продукты и проводит различные обучающие мероприятия для всех сотрудников банка. Мы помогаем коллегам развивать их профессиональные и менеджерские компетенции, создаем классный опыт корпоративного обучения.\n\nМы вам доверим:\n— Проектирование и верстку лендингов для различных программ обучения;\n— Участие в разработке AI-тренажёров для обучения и развития сотрудников;\n— Переработку и создание обучающего контента — например, превращение материалов в one-pagers и другие удобные форматы;\n— Разработку тестов и опросов для оценки эффективности обучающих материалов;\n— Первичное взаимодействие с внешними провайдерами — поиск, сбор и анализ предложений;\n— Участие в проведении исследований для выявления потребностей и эффективности обучающих продуктов.\n\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности менеджмент в образовании, проектирование образовательных программ, методология профессионального образования, педагогического проектирования, социология, психология, управление персоналом, педагогика и смежных направлений;\n— знает английский язык на уровне Intermediate и выше;\n— владеет навыком работы в иллюстраторах, Figma и другие;\n— обладает грамотной устной и письменной речью;\n— умеет искать и анализировать информацию из различных источников;\n— имеет навыки работы с искуственным интеллектом и понимает алгоритм работы с ними — включая написание промптов и использование ИИ-инструментов для обработки и анализа информации..\n\nБудет плюсом:\n—  Excel на начальном уровне;"}]}, {"group": "Продуктовый менеджмент (Product Management)", "items": [{"title": "Product Management", "desc": "Команда: \nКоманда инвестиций для физических лиц\n\nОписание команды:\nМы делаем инвестиции доступными с помощью мобильного приложения, простыми и понятными для каждого — вне зависимости от финансовой цели. Мы развиваем два ключевых направления: брокерское обслуживание для клиентов, которые хотят управлять своими вложениями самостоятельно, и доверительное управление — для тех, кто предпочитает доверить финансы профессионалам.\n\nМы вам доверим:\n— анализировать обратную связь клиентов по инвестиционным продуктам — из call-центра, опросов и других источников — и выделять основные боли и точки роста;\n— участвовать в клиентских исследованиях: готовить опросы, проводить интервью, собирать и структурировать данные;\n— анализировать предложения конкурентов и отслеживать тренды на рынке инвестиционных продуктов;\n— изучать клиентский путь в инвестиционных продуктах, выявлять слабые места и точки улучшения;\n— генерировать гипотезы и готовить предложения по улучшению клиентского опыта на основе аналитики и исследований.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 30 часов в неделю (гибридный формат);\n— студент или выпускник направления бизнес-информатика, менеджмент, управление проектами, экономика, финансы, маркетинг и смежных;\n— знает английский язык на уровне Intermediate и выше;\n—  владеет Excel на среднем уровне;\n—  владеет PowerPoint на продвинутом уровне;\n— умеет структурно мыслить;\n— проактивен и умеет уверенно отстаивать свою точку зрения, сохраняя конструктивный подход.\n\nБудет плюсом:\n— понимание фондового рынка;\n— опыт работы в продуктовой команде; \n— участие в кейс чемпионатах, хакатонах или других проектах."}, {"title": "nan", "desc": "nan"}, {"title": "nan", "desc": "nan"}, {"title": "nan", "desc": "nan"}]}, {"group": "Риск-аналитика (Analytics)", "items": [{"title": "Портфельная риск-аналитика", "desc": "Команда: \n Отдел портфельного менеджмента и аналитики\n\nОписание команды:\nКоманда портфельного риск-менеджмента занимается анализом уровня риска и сегментацией активного кредитного портфеля физ.лиц, выявляет проблемные зоны и потенциальные зоны роста, формирует правила кредитования клиентов, обеспечивающие приемлемый уровень риска для банка и наиболее удобный и быстрый процесс рассмотрения заявок для клиентов. \n\nМы вам доверим:\n— Анализ розничного кредитного портфеля и тенденций его развития: работу с ежемесячными отчетами, мониторинг ключевых показателей;\n— Идентификацию рисков розничного кредитования: выработку предложений по оптимизации условий и процессов кредитования физических лиц, а также контроль за их реализацией;\n— Подготовку ежемесячных, ежеквартальных и ежегодных аналитических обзоров и презентаций для руководства Банка;\n— Участие в согласовании предложений по развитию розничных кредитных продуктов и изменению процессов кредитования, а также подготовку аналитических заключений для Кредитного комитета Банка.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности экономика, математика и технических дисциплин;\n— знает английский язык на уровне Upper-Intermediate и выше;\n— имеет навыки работы в Excel на продвинутом уровне (сводные таблицы, ВПР, макросы) и базовыми знаниями Power BI;\n\nБудет плюсом:\n— обладает навыком программирования Python (уровень аналитика);\n— обладает основами Data Scientist (математическая статистика, моделирование и тд)"}]}, {"group": "Соотвествие и контроль (Compliance)", "items": [{"title": "Комплаенс-контроль на финансовых рынках", "desc": "Команда: \nКоманда комплаенс-контроля на финансовых рынках\n\nОписание команды:\nНаша команда отвечает за систему внутреннего контроля, которая помогает банку соответствовать локальным требованиям и международным стандартам на финансовых рынках. Мы следим, чтобы новые продукты и услуги были законны, проводим мониторинг и анализ сделок на рынке ценных бумаг, выявляем конфликты интересов и регуляторные риски.\n\nМы вам доверим:\n— Проведение оценки соответствия деятельности дочерней компании требованиям законодательства, корпоративным и международным стандартам;\n— Выявление и анализ комплаенс-рисков для предотвращения нарушений и санкций;\n— Подготовку и обновление внутренней нормативно-документальной базы;\n— Проведение анализа бизнес-процессов и сделок на предмет комплаенс-рисков;\n— Работу с обращениями клиентов и участие в расследованиях потенциальных нарушений;\n— Консультирование сотрудников по вопросам применения правовых и этических норм;\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (очный формат);\n— образование в области корпоративных и международных финансов, финансового менеджмента, комплаенса и профилактики правовых рисков, экономическая безопасность или смежных направлениях;\n— знает английский язык на уровне Upper-Intermediate и выше;\n— владеет MS Excel на продвинутом уровне (сводные таблицы, ВПР, макросы);\n— умеет правильно интерпретировать законодательные акты и составлять документы;\n— нацелен на результат, умеет анализировать большие объёмы данных и погружаться в сложные процессы;\n— проходит обучение по корпоративным и международным финансам, финансовому менеджменту, комплаенсу и профилактике правовых рисков или смежным направлениям.\n\nБудет плюсом:\n — имеет знания SQL и Python на базовом уровне."}, {"title": "Антикорупционный комплаенс", "desc": "Команда: \nКоманда соответствия внутрикорпоративным стандартам\n\nОписание команды:\nКоманда занимается управлением рисками конфликта интересов, противодействием коррупции и взяточничеству, а также обеспечивает соблюдение антикоррупционных требований в ключевых бизнес-процессах. Основные направления работы включают контроль за подарками и приглашениями, спонсорством, благотворительностью, закупками и взаимодействием с агентами.\n\nМы вам доверим:\n— Участвовать в оценке конфликтов интересов и разработке мер по их минимизации;\n— Вести и актуализировать профили сотрудников, контролировать исполнение их антикоррупционных обязательств;\n— Согласовывать договоры с учетом антикоррупционных требований;\n— Принимать участие в рассмотрении мероприятий, подарков и приглашений в рамках соблюдения политики компании.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 35 часов в неделю (очный формат);\n— образование по направлению: юриспруденция, право, комплаенс-контроль, экономическая безопасность и смежных направлениях;\n— понимание что такое комплаенс и зачем он нужен в коммерческой организации;\n— имеет навыки работы в MS Excel и PowerPoint на продвинутом уровне;\n— знает английский язык на уровне Intermediate и выше;\n— обладает аналитическим мышлением, способностью быстро обучаться и погружаться в детали;\n— умеет структурировать большое количество информации;\n— нацелен на результат и развитие в сфере комплаенс.\n\nБудет плюсом:\n — понимание как работают алгоритмы и их отличие от LLM;\n — опыт подготовки технических заданий для автоматизаций."}]}, {"group": "Финансовая аналитика (Finance & Consulting)", "items": [{"title": "Финансовый анализ и планирование", "desc": "Команда: \nОтдел финансового планирования и анализа \n\nОписание команды:\nМы анализируем доходность, участвуем в разработке бюджета и оцениваем тарифы текущих продуктов, а также участвуем в запуске новых. Наша цель — вносить свой вклад в устойчивый рост наших продуктов через предоставление точных финансовых моделей и качественной финансовой аналитики.\n\nМы вам доверим:\n— Изучать текущие финансовые модели розничных продуктов банка;\n— Участвовать в процессе бюджетирования и планирования показателей розничных продуктов.\n— Строить статистические модели продуктов и профили поведения клиентов.\n— Работать с базами данных и совместно с продуктовыми командами анализировать доходность розничных продуктов банка.\n— Поддерживать существующие отчеты и участвовать в разработке новых аналитических отчетов.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности экономика, математическая статистика, финансы или смежное;\n— знает английский язык на уровне Intermediate и выше;\n— имеет навыки работы в MS Excel на продвинутом уровне (Power Query и макросы);\n— обладает базовыми знаниями SQL (Select, Joins);\n— имеет развитое системное мышление и обладает аналитическим складом ума.\n\nБудет плюсом:\n\n— владеет программированием на Python;"}, {"title": "Автоматизация управленческой отчетности", "desc": "Команда: \nОтдел управления расходами\n\nОписание команды:\nНаша команда занимается подготовкой управленческой отчетности по расходам Банка, обеспечением точности и актуальности данных, автоматизацияй процессов, а также методологическим сопровождением отчетных процессов.\n\nМы вам доверим:\n— Участвовать в ежемесячном закрытии: обновлять финансовые модели и помогать в подготовке управленческой отчетности;\n— Работать с данными: заниматься их загрузкой, проверкой, анализом и обработкой;\n— Участвовать в проектах по оптимизации и автоматизации процессов в том числе через использование LLM;\n— Взаимодействовать с командой разработки при формировании технических заданий для автоматизации и улучшения процессов.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности экономика, финансы или смежное;\n— готов работать от 25 часов в неделю (гибридный формат);\n— имеет образование в области экономики, финансов и смежных направлений;\n— знает английский язык на уровне Intermediate и выше;\n— имеет навыки работы в Excel на продвинутом уровне (сводные таблицы, ВПР, Power Query);\n—  владеет SQL на базовом уровне;\n— имеет навыки промптинга для работы с LLM; \n— обладает аналитическим складом ума и проактивен.\n\nБудет плюсом:\n— владеет программированием на Python;"}, {"title": "Стратегия и развитияе корпоративных банковских продуктов", "desc": "Команда: \nКоманда стратегии и развития корпоративных банковских продуктов\n\nОписание команды:\nКоманда бизнес развития и стратегии отвечает за разработку и реализацию стратегии корпоративно-инвестиционного бизнеса. Наша цель — постоянно повышать эффективность, прибыльность и конкурентоспособность корпоративного бизнеса. Мы отвечаем за анализ бизнес-результатов одного из бизнес сегментов, планирование и мониторинг бюджета, участвуем в постановке целей и в управлении эффективностью.\n\nМы вам доверим:\n— Собирать и анализировать данные по рынку, продуктам и клиентам, используя открытые источники и внутренние данные банка;\n— Выявлять точки роста и повышения эффективности работы команд;\n— Участвовать в целепологании для продуктовых команд;\n— Участие в рабочих встречах, брейнштормах и презентациях результатов работы.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности экономика, финансы, инвестиционный менеджмент, банковское дело, международные отношения и смежное;\n— знает английский язык на уровне Intermediate и выше;\n— владеет Excel, SQL и Python на среднем уровне;\n— обладает аналитическим мышлением и стремлением к обучению;\n— участвовал в кейс чемпионатах или имеет реелватный опыт работы / практики."}, {"title": "Подготовка и аналитика управленческой отчетности", "desc": "Команда: \nКоманда управленческой отчетности\n\nОписание команды:\nМы готовим управленческую отчетность и аналитику по банку, являемся бизнес-партнерами продуктовых команд и участвуем в оценке эффективности бизнес решений и выработке стратегического видения развития бизнес сегментов, продуктов и банка в целом\n\nМы вам доверим:\n— участвовать в подготовке ежедневной и ежемесячной управленческой отчетности по результат сегментов корпоративного бизнеса, финансовых институтов, а также операций на рынках капитала;\n— отвечать на запросы бизнеса по предоставляемым данным и отчетам (анализировать и объяснять динамику результата по сегменту, продукту, клиенту);\n— принимать участие в запуске изменений в продуктовой линейке сегмента корпоративного бизнеса — предлагать изменения в отчеты, создавать новые, фокусируясь на основных задачах блока.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— студент или выпускник по специальности экономика, финансы, банковское дело, международные отношения и смежное;\n— знает английский язык на уровне Intermediate и выше;\n— имеет навыки работы в MS Excel на среднем уровне (сводные таблицы, ВПР, макросы);\n— обладает базовыми знаниями SQL (Select, Joins);\n— владеет высоким уровнем коммуникаций и проактивен в решении задач.\n\nБудет плюсом:\n— владеет инсутрментами визуализации аналитики (BI);"}, {"title": "nan", "desc": "nan"}]}, {"group": "Юридическое сопровождение (Law & Legal )", "items": [{"title": "nan", "desc": "nan"}]}, {"group": "UX/UI Designer", "items": [{"title": "UX/UI Designer", "desc": "Команда: \nКоманда дизайна приложения для филических лиц\n\nОписание команды:\nКоманда отвечает за платежи, переводы и анализ бюджета. Мы делаем повседневные операции простыми и безопасными и помогаем клиентам следить за расходами без лишней суеты. Вместе с нами вы сможете развивать сценарии оплаты, внедрять полезные рекомендации по бюджету и запускать защитные функции, которые делают финансовые операции ещё надёжнее.\n\nМы вам доверим:\n— создавать интерфейсы и их концепты для iOS и Android в продуктовой команде;\n— проводить исследования клиентского опыта в рамках стратегии self-driven bank;\n—  участвовать в развитии дизайн-системы;\n— готовить макеты и документацию для команд разработки мобильных продуктов;\n— работать в связке с дизайнерами, менеджерами продуктов, редакторами, исследователями, аналитиками.\n\nНаш идеальный кандидат: \n— живет в Москве и готов работать от 25 часов в неделю (гибридный формат);\n— имеет высшее образование / обучается на направлении дизайна мобильных интерфейсов, цифрового дизайна,  веб-разработки или смежных направлениях связанных с UX/UI дизайном;\n— умеет работать в Figma на продвинутом уровне;\n— имеет опыт учебных проектов / работы связанных с дизайном мобильных приложений.\n\nБудет плюсом:\n— навык работы с 3D иллюстрациями\n— портфолио дизайн-макетов мобильных приложений"}]}];

/* =========================================================
   Platform context: Telegram / VK
========================================================= */
const APP_CONTEXT = {
  platform: "web",
  tg_init_data: "",
  tg_user_id: "",
  tg_start_param: "",
  vk_launch_params: ""
};

(function initPlatform() {
  // Telegram
  try {
    const tg = window.Telegram?.WebApp;
    if (tg) {
      APP_CONTEXT.platform = "telegram";
      APP_CONTEXT.tg_init_data = tg.initData || "";
      const u = tg.initDataUnsafe?.user;
      if (u?.id) APP_CONTEXT.tg_user_id = String(u.id);
      if (tg.initDataUnsafe?.start_param) APP_CONTEXT.tg_start_param = String(tg.initDataUnsafe.start_param);
      try { tg.ready(); tg.expand(); } catch (_) {}
    }
  } catch (_) {}

  // VK
  (async () => {
    try {
      const vkBridge = window.vkBridge;
      if (!vkBridge) return;
      await vkBridge.send("VKWebAppInit");
      APP_CONTEXT.platform = "vk";
      APP_CONTEXT.vk_launch_params = window.location.search ? window.location.search.replace(/^\?/, "") : "";
    } catch (_) {}
  })();
})();

/* =========================================================
   Persist form state (localStorage)
========================================================= */
const FORM_STATE_KEY = "ft-bank-reg-form-state:v2";

function readState() {
  try {
    const raw = localStorage.getItem(FORM_STATE_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch (_) {
    return null;
  }
}
function writeState(state) {
  try { localStorage.setItem(FORM_STATE_KEY, JSON.stringify(state)); } catch (_) {}
}
function clearState() {
  try { localStorage.removeItem(FORM_STATE_KEY); } catch (_) {}
}
function debounce(fn, wait = 350) {
  let t = null;
  return (...args) => {
    if (t) clearTimeout(t);
    t = setTimeout(() => fn(...args), wait);
  };
}
function captureFormState(formEl) {
  const state = {};
  const els = formEl.querySelectorAll("input, select, textarea");
  els.forEach((el) => {
    if (!el.name) return;
    if (el.type === "checkbox") state[el.name] = !!el.checked;
    else if (el.type === "radio") {
      if (el.checked) state[el.name] = el.value;
    } else state[el.name] = el.value;
  });
  return state;
}
function applyFormState(formEl, state) {
  if (!state) return;
  const els = formEl.querySelectorAll("input, select, textarea");
  els.forEach((el) => {
    if (!el.name) return;
    if (!(el.name in state)) return;
    if (el.type === "checkbox") el.checked = !!state[el.name];
    else if (el.type === "radio") el.checked = String(state[el.name]) === String(el.value);
    else el.value = state[el.name];
  });
}

/* =========================================================
   UI helpers
========================================================= */
function $(id) { return document.getElementById(id); }

function setVisible(el, on) {
  if (!el) return;
  el.style.display = on ? "block" : "none";
}

function resetSelect(sel, placeholder="— Выберите —") {
  if (!sel) return;
  sel.innerHTML = "";
  const o = document.createElement("option");
  o.value = "";
  o.textContent = placeholder;
  sel.appendChild(o);
}

function fillSelectWithGroups(select, groups) {
  resetSelect(select, "— Выберите —");
  groups.forEach((g) => {
    const og = document.createElement("optgroup");
    og.label = g.group;
    (g.items || []).forEach((it) => {
      const opt = document.createElement("option");
      opt.value = it.title;
      opt.textContent = it.title;
      opt.dataset.desc = it.desc || "";
      og.appendChild(opt);
    });
    select.appendChild(og);
  });
}

function showDesc(select, descEl) {
  if (!select || !descEl) return;
  const opt = select.selectedOptions?.[0];
  const desc = opt?.dataset?.desc || "";
  if (desc && desc.trim()) {
    descEl.textContent = desc.trim();
    setVisible(descEl, true);
  } else {
    descEl.textContent = "";
    setVisible(descEl, false);
  }
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || "").trim());
}

/* =========================================================
   Date picker (day/month/year -> hidden YYYY-MM-DD)
========================================================= */
function initBirthDatePicker() {
  const day = $("birth_day");
  const month = $("birth_month");
  const year = $("birth_year");
  const hidden = $("birth_date");
  if (!day || !month || !year || !hidden) return;

  // days
  if (day.options.length <= 1) {
    for (let d=1; d<=31; d++) {
      const opt = document.createElement("option");
      opt.value = String(d).padStart(2, "0");
      opt.textContent = String(d);
      day.appendChild(opt);
    }
  }

  // months
  const months = [
    ["01","Январь"],["02","Февраль"],["03","Март"],["04","Апрель"],
    ["05","Май"],["06","Июнь"],["07","Июль"],["08","Август"],
    ["09","Сентябрь"],["10","Октябрь"],["11","Ноябрь"],["12","Декабрь"],
  ];
  if (month.options.length <= 1) {
    months.forEach(([v,t]) => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = t;
      month.appendChild(opt);
    });
  }

  // years
  if (year.options.length <= 1) {
    const nowY = new Date().getFullYear();
    const maxY = nowY - 14;
    const minY = nowY - 80;
    for (let y=maxY; y>=minY; y--) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      year.appendChild(opt);
    }
  }

  function daysInMonth(yyyy, mm) {
    return new Date(Number(yyyy), Number(mm), 0).getDate();
  }
  function clampDays() {
    if (!year.value || !month.value) return;
    const maxD = daysInMonth(year.value, month.value);
    const cur = Number(day.value || "0");
    for (let i=1; i<day.options.length; i++) {
      const d = Number(day.options[i].value);
      day.options[i].disabled = d > maxD;
    }
    if (cur > maxD) day.value = String(maxD).padStart(2, "0");
  }
  function syncHidden() {
    if (!year.value || !month.value || !day.value) {
      hidden.value = "";
      return;
    }
    hidden.value = `${year.value}-${month.value}-${day.value}`;
  }

  year.addEventListener("change", () => { clampDays(); syncHidden(); });
  month.addEventListener("change", () => { clampDays(); syncHidden(); });
  day.addEventListener("change", () => { syncHidden(); });

  // If hidden already has value (restored)
  if (hidden.value && /^\d{4}-\d{2}-\d{2}$/.test(hidden.value)) {
    const [yy, mm, dd] = hidden.value.split("-");
    year.value = yy;
    month.value = mm;
    clampDays();
    day.value = dd;
    syncHidden();
  }
}

/* =========================================================
   Main
========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  const form = $("reg-form");
  const resultEl = $("result");
  const errorEl = $("error");
  const emailErrorEl = $("email-error");

  if (!form) return;

  // Elements
  const city = $("city");
  const cityOtherBlock = $("city_other_block");
  const tzBlock = $("timezone_diff_block");
  const cityOther = $("city_other");
  const tz = $("timezone_diff");

  const specialty = $("specialty");
  const specialtyOtherBlock = $("specialty_other_block");
  const specialtyOther = $("specialty_other");

  const direction = $("internship_direction");

  const onlineCoursesBlock = $("online_courses_block");
  const onlineCourses = $("online_courses");
  const onlineCourseYearBlock = $("online_course_year_block");
  const onlineCourseYear = $("online_course_year");
  const onlineCourseYearOtherBlock = $("online_course_year_other_block");
  const onlineCourseYearOther = $("online_course_year_other");

  const prioritiesBlock = $("priorities_block");
  const priority1 = $("priority1");
  const priority2 = $("priority2");
  const p1Desc = $("priority1_description");
  const p2Desc = $("priority2_description");

  const policyLink = $("policy-link");
  const policyText = $("policy-text");

  function clearMessages() {
    if (resultEl) resultEl.textContent = "";
    if (errorEl) errorEl.textContent = "";
    if (emailErrorEl) {
      emailErrorEl.style.display = "none";
      emailErrorEl.textContent = "";
    }
  }

  // policy toggle
  if (policyLink && policyText) {
    policyLink.addEventListener("click", () => {
      policyText.style.display = (policyText.style.display === "block") ? "none" : "block";
    });
  }

  // init date picker first (so options exist)
  initBirthDatePicker();

  // City blocks
  function updateCityBlocks() {
    const v = city?.value || "";
    const isOther = v === "Другой";
    setVisible(cityOtherBlock, isOther);
    setVisible(tzBlock, isOther);
    if (!isOther) {
      if (cityOther) cityOther.value = "";
      if (tz) tz.value = "";
    }
  }
  if (city) city.addEventListener("change", updateCityBlocks);

  // Specialty "other"
  function updateSpecialtyBlocks() {
    const isOther = (specialty?.value || "") === "Другое";
    setVisible(specialtyOtherBlock, isOther);
    if (!isOther && specialtyOther) specialtyOther.value = "";
  }
  if (specialty) specialty.addEventListener("change", updateSpecialtyBlocks);

  // Online courses year
  function updateOnlineCourseYear() {
    const provider = onlineCourses?.value || "";
    const showYear = provider && provider !== "Не проходил(а)";
    setVisible(onlineCourseYearBlock, !!showYear);

    if (!showYear) {
      if (onlineCourseYear) onlineCourseYear.value = "";
      if (onlineCourseYearOther) onlineCourseYearOther.value = "";
      setVisible(onlineCourseYearOtherBlock, false);
      return;
    }

    const isOtherYear = (onlineCourseYear?.value || "") === "Другой";
    setVisible(onlineCourseYearOtherBlock, isOtherYear);
    if (!isOtherYear && onlineCourseYearOther) onlineCourseYearOther.value = "";
  }
  if (onlineCourses) onlineCourses.addEventListener("change", updateOnlineCourseYear);
  if (onlineCourseYear) onlineCourseYear.addEventListener("change", updateOnlineCourseYear);

  // Priorities descriptions
  if (priority1) priority1.addEventListener("change", () => showDesc(priority1, p1Desc));
  if (priority2) priority2.addEventListener("change", () => showDesc(priority2, p2Desc));

  function fillPriorities(kind) {
    const groups = kind === "IT" ? IT_TRACK_GROUPS : NONIT_TRACK_GROUPS;
    fillSelectWithGroups(priority1, groups);
    fillSelectWithGroups(priority2, groups);
    showDesc(priority1, p1Desc);
    showDesc(priority2, p2Desc);
  }

  // Direction blocks
  function updateDirectionBlocks() {
    const v = direction?.value || "";
    const isIT = (v === "IT" || v === "ИТ");
    const isBiz = (v === "Бизнес" || v === "Non-IT" || v === "не IT");

    // online courses only for IT
    setVisible(onlineCoursesBlock, isIT);
    if (!isIT) {
      if (onlineCourses) onlineCourses.value = "";
      if (onlineCourseYear) onlineCourseYear.value = "";
      if (onlineCourseYearOther) onlineCourseYearOther.value = "";
      setVisible(onlineCourseYearBlock, false);
      setVisible(onlineCourseYearOtherBlock, false);
    }

    const showPr = isIT || isBiz;
    setVisible(prioritiesBlock, showPr);

    if (showPr) {
      fillPriorities(isIT ? "IT" : "BIZ");
    } else {
      resetSelect(priority1);
      resetSelect(priority2);
      setVisible(p1Desc, false);
      setVisible(p2Desc, false);
    }
  }
  if (direction) direction.addEventListener("change", updateDirectionBlocks);

  // Restore form state AFTER listeners & init
  applyFormState(form, readState());

  // Now run updates once to reflect restored values
  updateCityBlocks();
  updateSpecialtyBlocks();
  updateOnlineCourseYear();
  updateDirectionBlocks();
  initBirthDatePicker(); // повторная синхронизация даты после restore

  // Persist changes
  const persist = debounce(() => writeState(captureFormState(form)), 350);
  form.addEventListener("input", persist);
  form.addEventListener("change", persist);

  // Submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearMessages();

    const data = {};
    const fd = new FormData(form);
    for (const [k, v] of fd.entries()) data[k] = String(v || "").trim();

    // Ensure hidden birth_date is synced
    const hiddenBirth = $("birth_date");
    if (hiddenBirth) data.birth_date = String(hiddenBirth.value || "").trim();

    // Normalize specialty
    if (data.specialty !== "Другое") data.specialty_other = "";

    // City normalization
    if (data.city !== "Другой") {
      data.city_other = "";
      data.timezone_diff = "";
    }

    // Direction label: display "ИТ", but keep sending IT for backend.
    if (data.internship_direction === "ИТ") data.internship_direction = "IT";

    // Online courses only for IT
    if (data.internship_direction !== "IT") {
      data.online_courses = "";
      data.online_course_year = "";
      data.online_course_year_other = "";
    } else {
      if (!data.online_courses || data.online_courses === "Не проходил(а)") {
        data.online_course_year = "";
        data.online_course_year_other = "";
      } else {
        if (data.online_course_year !== "Другой") data.online_course_year_other = "";
      }
    }

    // Basic validation (minimum for UX)
    if (!data.last_name || !data.first_name) {
      if (errorEl) errorEl.textContent = "Пожалуйста, заполните имя и фамилию.";
      return;
    }
    if (!data.email || !isValidEmail(data.email)) {
      if (emailErrorEl) {
        emailErrorEl.style.display = "block";
        emailErrorEl.textContent = "Пожалуйста, укажите корректный e-mail.";
      }
      return;
    }
    if (!data.phone) {
      if (errorEl) errorEl.textContent = "Пожалуйста, укажите номер телефона.";
      return;
    }
    if (!data.birth_date) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите дату рождения.";
      return;
    }
    if (!data.city) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите город проживания.";
      return;
    }
    if (data.city === "Другой" && !data.timezone_diff) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите разницу во времени относительно Мск.";
      return;
    }
    if (!data.education_degree) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите степень образования.";
      return;
    }
    if (data.education_degree !== "Нет высшего образования" && !data.graduation_year) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите год выпуска.";
      return;
    }
    if (!data.specialty) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите специальность.";
      return;
    }
    if (data.specialty === "Другое" && !data.specialty_other) {
      if (errorEl) errorEl.textContent = "Пожалуйста, укажите специальность.";
      return;
    }
    if (!data.internship_direction) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите направление стажировки.";
      return;
    }
    if (!data.priority1 || !data.priority2) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите 2 приоритетных направления.";
      return;
    }
    if (!data.hours_per_week) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите количество часов.";
      return;
    }
    if (!data.ready_6_months) {
      if (errorEl) errorEl.textContent = "Пожалуйста, выберите готовность на 6 месяцев.";
      return;
    }

    // Platform meta required by backend
    if (APP_CONTEXT.platform === "telegram") {
      data.tg_init_data = APP_CONTEXT.tg_init_data || "";
    } else if (APP_CONTEXT.platform === "vk") {
      // If you later support VK on backend
      data.vk_launch_params = APP_CONTEXT.vk_launch_params || "";
    }

    try {
      const res = await fetch(FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const js = await res.json().catch(() => null);

      if (!res.ok) {
        if (errorEl) errorEl.textContent = js?.error || `Ошибка отправки (HTTP ${res.status})`;
        return;
      }

      if (js && js.duplicate) {
        if (resultEl) resultEl.textContent = js.message || "Мы уже нашли вашу заявку ✅";
        return;
      }

      if (resultEl) resultEl.textContent = "Данные отправлены ✅";
      clearState();
    } catch (err) {
      if (errorEl) errorEl.textContent = "Ошибка отправки: " + (err?.message || String(err));
    }
  });
});
